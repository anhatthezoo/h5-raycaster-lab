var O2 = require('o2');
var CONST = require('../data/consts.js');
var Effect = require('../Effects.js');
var Scroll = require('./Abstract/Scroll.js');
var u = require('../Utils.js');

/**
 * Scroll of Teleport :
 * Le lanceur de sort se téléporte à un endroit aléatoire 
 */
O2.extendClass('ScrollTeleport', Scroll, {
	read: function(ctx) {
		var nRadius = 10;
		var oInst = ctx.instance;
		var oEntity = ctx.caster;
		// 1: choisir un endroit
		// 2: appliquer des effets visuel au départ et à l'arrivée
		// 3: déplacer le caster
		// 4: informer les clients
		var aEnt, oSector;
		var x = oEntity.xSector;
		var y = oEntity.ySector;
		var nDistance = nRadius;
		var aSectors = null;
		var i, ix, iy, nSize = oInst.getMapSize();
		
		var checkAndPush = function(cx, cy) {
			if (cy >= 0 && cy < nSize && cx >= 0 && cx < nSize && oInst.isWalkable(cx, cy)) {
				aSectors.push([cx, cy]);
			}
		};
		
		while (nDistance > 0) {
			aSectors = [];
			for (i = - nDistance; i < nDistance; ++i) {
				ix = i + x;
				checkAndPush(ix, y - nDistance); // bord supérieur
				checkAndPush(ix, y + nDistance); // bord inférieur
				iy = i + y;
				checkAndPush(x - nDistance, iy); // gauche
				checkAndPush(x + nDistance, iy); // droite
			}
			while (aSectors.length > 0) {
				oSector = u.choose(aSectors);
				x = oSector[0];
				y = oSector[1];
				aEnt = oInst.getMapBlockProp(x, x, 'entities');
				if (aEnt.length === 0) {
					// téléporter l'entité ici !
					oInst.teleportEntity(oEntity, x, y);
					return;
				}
			}
			--nDistance;
		}		
	}
});

module.exports = ScrollTeleport;
